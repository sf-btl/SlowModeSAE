// 1. Définition de la connexion
generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Connection URLs (DATABASE_URL) are configured outside the
// schema for Prisma v7 (use `prisma.config.ts` or environment variables).

// ==========================================
// GESTION DES UTILISATEURS (Héritage)
// ==========================================

model Utilisateur {
  id              Int      @id @default(autoincrement())
  email           String   @unique
  mot_de_passe    String
  nom             String
  prenom          String
  adresse_postale String?
  ville           String?
  createdAt       DateTime @default(now())

  // Relations 1:1
  acheteur    Acheteur?
  couturier   Couturier?
  fournisseur Fournisseur?
}

model Acheteur {
  // ICI : L'ID est à la fois PK et FK. Pas d'auto-incrément.
  utilisateurId Int         @id
  utilisateur   Utilisateur @relation(fields: [utilisateurId], references: [id])

  mensurations String?

  // Relations
  commandes Commande[]
}

model Couturier {
  // ICI : Idem
  utilisateurId Int         @id
  utilisateur   Utilisateur @relation(fields: [utilisateurId], references: [id])

  bio_description   String?
  annees_experience Int?
  note_moyenne      Float?  @default(0)

  // Relations
  commandesGerees Commande[]
  patronsCrees    Patron[]
  postsPublies    Post[]
  produits        Produit[]
  prices          CouturierPrice[]
}

model Fournisseur {
  // ICI : Idem
  utilisateurId Int         @id
  utilisateur   Utilisateur @relation(fields: [utilisateurId], references: [id])

  siret        String @unique
  nom_societe  String
  note_moyenne Float? @default(0)

  // Relations
  commandesExpediees Commande[]
  postsSponsorises   Post[]
  tissusVendus       Tissu[]
}

// ==========================================
// COMMANDES & PRODUITS
// ==========================================

model Commande {
  id                Int      @id @default(autoincrement())
  date_commande     DateTime @default(now())
  statut            String   @default("EN_ATTENTE")
  adresse_livraison String
  montant_total     Float
  type              CommandeType @default(PRODUIT)

  // Relations : Note que le champ de liaison change de nom pour être plus clair
  // Il pointe maintenant vers "utilisateurId" de la table Acheteur/Couturier

  acheteurId Int
  acheteur   Acheteur @relation(fields: [acheteurId], references: [utilisateurId])

  couturierId Int?
  couturier   Couturier? @relation(fields: [couturierId], references: [utilisateurId])

  fournisseurId Int?
  fournisseur   Fournisseur? @relation(fields: [fournisseurId], references: [utilisateurId])

  lignes LigneCommande[]
  projet ProjetCommande?
}

enum CommandeType {
  PRODUIT
  PROJET
}

enum TypeProjet {
  CREATION
  RETOUCHE
}

enum CategorieVetement {
  TOPS
  BOTTOMS
  FULL_BODY
  OUTERWEAR
  LINGERIE
  ACCESSORIES
}

model ProjetCommande {
  id             Int      @id @default(autoincrement())
  commandeId     Int      @unique
  commande       Commande @relation(fields: [commandeId], references: [id])

  typeProjet     TypeProjet
  categorie      CategorieVetement
  tissuId        Int?
  tissu          Tissu?   @relation(fields: [tissuId], references: [id])
  description    String?
  images         String[]
  mensurations   Json
}

model LigneCommande {
  id              Int      @id @default(autoincrement())
  quantite        Int
  prix_unitaire   Float    // Prix au moment de la commande

  commandeId      Int
  commande        Commande @relation(fields: [commandeId], references: [id])

  produitId       Int?
  produit         Produit?  @relation(fields: [produitId], references: [id])

  tissuId         Int?
  tissu           Tissu?    @relation(fields: [tissuId], references: [id])
}

enum CategorieProduit {
  CHEMISE
  T_SHIRT
  PULL
  VESTE
  MANTEAU
  PANTALON
  JUPE
  ROBE
  COMBINAISON
  ACCESSOIRE
  AUTRE
}

model Produit {
  id            Int       @id @default(autoincrement())
  nom_produit   String
  categorie     CategorieProduit @default(AUTRE)
  description   String?
  imagePath     String?
  prix_unitaire Float
  couturierId   Int
  couturier     Couturier @relation(fields: [couturierId], references: [utilisateurId])

  stock Int

  lignes LigneCommande[]
  posts     Post[]
}

// ==========================================
// AUTRES (Patrons, Posts, Tissus)
// ==========================================

model Patron {
  id          Int    @id @default(autoincrement())
  nom_patron  String
  fichier_pdf String

  couturierId Int
  couturier   Couturier @relation(fields: [couturierId], references: [utilisateurId])
}

model Post {
  id               Int      @id @default(autoincrement())
  titre_creation   String
  date_publication DateTime @default(now())
  description      String?
  photo_resultat   String?

  // Auteur du post
  couturierId Int?
  couturier   Couturier? @relation(fields: [couturierId], references: [utilisateurId])

  fournisseurId Int?
  fournisseur   Fournisseur? @relation(fields: [fournisseurId], references: [utilisateurId])

  produitId Int?
  produit   Produit? @relation(fields: [produitId], references: [id])

  tissuId Int?
  tissu   Tissu? @relation(fields: [tissuId], references: [id])
}

model Tissu {
  id            Int         @id @default(autoincrement())
  matiere       String
  grammage      Int?
  couleur       String
  metrage_dispo Float
  prix_unitaire Float
  imagePath     String
  fournisseurId Int
  fournisseur   Fournisseur @relation(fields: [fournisseurId], references: [utilisateurId])
  
  lignes        LigneCommande[]
  posts         Post[]
  projets       ProjetCommande[]
}

// Prices set by couturiers for personalized projects
model CouturierPrice {
  id          Int               @id @default(autoincrement())
  couturierId Int
  couturier   Couturier         @relation(fields: [couturierId], references: [utilisateurId])

  typeProjet  TypeProjet
  categorie   CategorieVetement?
  prix        Float

  @@unique([couturierId, typeProjet, categorie])
}
